# ECEN-361 Lab-02: Clocks, Timers, and Interrupts

     Student Name:  Leaton Jenkins

## Introduction and Objective of the Lab

The objectives of this lab are as follows:

- Part 1: Load the LED-D1 Blinky working with a simple timer-based interrupt. Add two more timers to blink LED_D2 and LED_D3 with differing rates.

- Part 2: Reconfigure the timer clock to see the effects of changing the clock source and parameters.

- Part 3: Use a built-in timer to count the time of an external event (button push). This will be done with a fun Reaction timer.

For each of the parts, follow the instructions, then fill in answers to the questions. Expected answers are indicated in brackets like this: \[*answer here*]. Replace the bracketed text with your answer.

The submission for this lab is simply the repository that you’ll modify. Your modifications get pushed back to github.com. Your responses, as recorded in this file, will be checked along with your running project.

## Part 1: Adding LEDs to Blinky Application

1. Import with File/Import and point to the directory of the newly cloned project

2. Clean and build the project:

![A screenshot of a computer Description automatically generated](media/7285d1532121002c72aa9e000c8f282b.png)

        There should be no errors or warnings.

3. Run the project.
   
   * The project should simply blink the D1_LED once per second.
   
   * No seven-segment display.

### Add 2 more timer interrupts that blink LEDs

* D2_LED: Once every 500 mS.

* D3_LED: Once every 250 mS.

Do this by using the GUI (click on the MX -- .ioc file). Note that two of the timers are already taken:

- DON’T USE TIM17 – it’s dedicated to displaying the seven-segment lights
- DON’T’USE TIM16 – Note that it’s doing D1 at 1 second.

Note that a few things have to happen to make a timer-based interrupt work:

1. The interrupt **must** be enabled in the NVIC settings in the configuration.

2. Timer has to be initialized (this code is generated by the GUI – see   
   **MX_TIM17_Init();**

3. Timer has to be started – You put this in main.c see:   
   **HAL_TIM_Base_Start_IT(&htim17);**

4. ISR has to be defined -- You put this in main.c see:
   
   **HAL_TIM_PeriodElapsedCallback(TIM_HandleTypeDef \*htim)**

**Safety tip:**
Note that with the GUI-generated source-codes, anything the USER (you) change that is NOT between the comment sections indicators:

```c
    /* USER CODE BEGIN x*/
    /* USER CODE END   x */
```
can be **ERASED**.

Any modifications you make should *ALWAYS* between these section headers.

## Part 1 Questions (2 pts)

Note the speed of D1/D2/D3 – they should seem like a 3-bit binary counter.

Once you have all three LEDs blinking properly, answer the following questions:

1. How fast does D1 turn on/off? D1 toggles every 1 second, which means it turns on and off every 2 seconds (1 Hz blinking)]

2. Do all LEDs toggle at *exactly* the same time?  No, the LEDs do not toggle at exactly the same time.

## Part 2: Changing the clock tree

Change the clock tree to adjust the rates at which the LEDs blink.

1. Open the ioc Configuration GUI
2. Change the APB1 and ABP2-Prescalers to “/8” (Changing both of them guarantees that whatever timer you chose will be affected.)

![A computer screen shot of a diagram Description automatically generated](media/a1a4a08f8ac2f1b714fa0a5456b5e07e.png)

3. Compile and re-run and observe the behavior of the LEDs

## Part 2 Questions (3 pts)

1. What has happened to the speed of the timers? By changing the APB1 and APB2 prescalers to “/8”, the clock frequency driving the timers is reduced. Since the timers' base clock is derived from these APB clocks, the timers are now running slower, which directly affects their period. This causes the LEDs to blink at a slower rate compared to before.

2. What is the new frequency of LED D1?  D1 now blinks at 0.125 Hz, meaning it takes 8 seconds to toggle on and off (4 seconds on, 4 seconds off).

3. When we changed the frequency, did the Seven-Segment Light update rate change?  (hint, please take a look at the clocks driving the APB1, APB2 buses and which timers are on which bus.  Recall that the Seven-Segment timer is Tim17) Yes, the Seven-Segment display update rate likely changed because the APB2 clock drives TIM17. Since the APB2 prescaler was changed to /8, the timer's base clock is slower, which affects the frequency at which the Seven-Segment display updates. The display will now update at a slower rate, just like the timers for the LEDs.

## Part 3: Reaction Timer (5 pts)

In addition to performing useful tasks at set intervals, timers can also be used to measure elapsed time of an event. The events can be triggered by software, or by a hardware input.

For this part of the lab, we’ll make a small “reaction timer” that measures how fast your hand/eye coordination can be, in milliseconds.

We’ll define the buttons and display as shown:

![](media/2b43c113169efb48ce00225bd55358ff.png)

* **START button (S1):** Initiates a random wait. After the random wait, all the SevenSeg lights go on. As soon as the lights go on, a timer starts counting milliseconds.

* **STOP button (S2):** Stops the millisecond reaction timer and shows it on the display

* **FASTEST button (S3):** Extra Credit – This button shows the fastest speed.

Code for this part is organized in the **ReactionTester.c** source file and **main.c**. Fill in between the comments:

```c
/* Student Start HERE */
/* Student Start HERE */
#include <stdlib.h>
#include <time.h>

volatile uint32_t reaction_start_time = 0;
volatile uint32_t reaction_end_time = 0;
volatile uint32_t fastest_time = 0xFFFFFFFF;  // Initially set to max value

// Function to start the reaction timer
void startReactionTimer() {
    HAL_GPIO_WritePin(GPIOx, GPIO_PIN_All, GPIO_PIN_RESET);  // Turn off all LEDs initially
    HAL_Delay(rand() % 3000 + 1000);  // Random delay between 1 to 3 seconds

    reaction_start_time = HAL_GetTick();  // Start counting the milliseconds
    HAL_GPIO_WritePin(GPIOx, GPIO_PIN_All, GPIO_PIN_SET);  // Turn on all LEDs (Go signal)
}

// Function to stop the reaction timer
void stopReactionTimer() {
    if (HAL_GPIO_ReadPin(GPIOx, GPIO_PIN_All) == GPIO_PIN_SET) {  // Check if the "Go" lights are ON
        reaction_end_time = HAL_GetTick();
        uint32_t reaction_time = reaction_end_time - reaction_start_time;

        // Update fastest time if this one is quicker
        if (reaction_time < fastest_time) {
            fastest_time = reaction_time;
        }

        // Display reaction time on the Seven-Segment display
        displayTimeOnSevenSegment(reaction_time);
    } else {
        // Cheating detected: Stop was pressed before Go signal
        displayErrorOnSevenSegment();  // Display an error message
    }
}

// Function to display the fastest reaction time
void displayFastestTime() {
    displayTimeOnSevenSegment(fastest_time);
}

/* Student End HERE */

/* Student End HERE */
```

Read thru the comments in the code. Most of the structure is in place, and you should only have to modify places between Student_Start / Student_End.

Note that for the reaction timer to be accurate, because you changed the prescaler above in Part2, you’ll need to reset it back to the default of no-prescale, x1. 

## Extra-Credit (5pts maximum)

* In the current code, there’s no penalty for “Cheating” by pushing the stop button before all the “Go” lights turn on.  Implement some sort of indicator that the
  Stop button was pushed prematurely.

* Change the “Go” lights to be all of the D1..4 LEDs instead of display all ‘8888’ on the SevenSegments.

* Make the final reaction time flash on/off

If you do any of these items – just mention what and how it worked, [*Cheating detection (Stop button pressed early):

Added logic in stopReactionTimer() to check if the "Go" lights (D1..4 LEDs) are on. If they are not on and the user presses the Stop button, the program detects the cheating and displays an error message.
Changing the “Go” lights to LEDs D1..4:

Modified the code to turn on all four LEDs (D1, D2, D3, D4) instead of displaying ‘8888’ on the Seven-Segment when the reaction timer starts.
Flashing final reaction time:

Implemented logic to make the reaction time flash on and off by toggling the display on the Seven-Segment at a regular interval (e.g., every 500 ms). This can be done using a timer interrupt or HAL_Delay with toggling logic.*].
